<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="shortcut icon" href="{{ url_for('static', filename='icon.png') }}">

        <title>• Overdark</title>
        
        <script type="text/javascript" src="/static/src/3rd_party/socket.io.min.js"></script>

        <!--script src="http://babylonjs.com/babylon.js"> </script-->

        <script src="/static/src/3rd_party/babylon.js"> </script>
        
        <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
        
    </head>
    
    <body>
        <canvas id="renderCanvas"></canvas>
        
        <div id="blocker"></div>  
        <div id="holder"></div>    
        <div id="circle" class="radius"></div>                     
        <div id="crosshair"></div>
        <div id="action"><div id="key">F</div><p id="action_text">Otevřít</p></div>
        <div id="status">
        	<div id="life_div">
        		<div id="life_progress"></div>
        		<p id="life_text">100%</p>
        	</div>
        	<div id="energy_div">
        		<div id="energy_progress"></div>
        		<p id="energy_text">100%</p>
        	</div>
        </div>
        
        <script type="text/javascript">
        
        function set_health(per) {
        	life_progress.style.width = per+"%";
        	life_text.innerHTML = life_progress.style.width;
        }
        
        function set_energy(per) {
        	energy_progress.style.width = per+"%";
        	energy_text.innerHTML = energy_progress.style.width;
        }
        
        </script>
        
        <div id="chatdiv" onload="whoami()">
          <div id=chat onmouseout="chat.scrollTop = chat.scrollHeight;">
            <table id=table>
            </table>
          </div>
          <input id=input type="text" onkeydown='klavesa()' onfocus="mazani()">
        </div>
        
        <div id="fps"></div>
        
        <div id="menu">
    		<div class="menu_window" id="main_window">
    			<p class="menu_nadpis1">Menu</p>
    			<hr>
        		<div class="button clickable" onclick="window_show('settings')">Nastavení</div>
        		<div class="button clickable" onclick="window.location.replace('logout')">Odhlásit se</div>
   		 	</div>
   		 	<div class="menu_window" id="settings_window">
    			<p class="menu_nadpis1">Nastavení</p>
    			<hr>
        		<div class="button clickable" onclick="window_show('graphic_settings')">Grafické nastavení</div>
        		<div class="button clickable" onclick="">Rozhraní</div>
        		<hr>
        		<div class="triple_button autowidth">
        			<div class="but storno" onclick="window_show('main')">Zpět</div>
        		</div>
   		 	</div>
   		 	<div class="menu_window" id="graphic_settings_window">
    			<p class="menu_nadpis1">Grafické nastavení</p>
    			<hr>
    			<p class="menu_podnadpis1">Kvalita modelů</p>
    			<div class="triple_button">
        			<div class="but left models_quality_but" onclick="settings_set('models_quality', 1, 'triplebutton')">Nízká</div>
        			<div class="but middle choosen models_quality_but" onclick="settings_set('models_quality', 2, 'triplebutton')">Střední</div>
        			<div class="but right models_quality_but" onclick="settings_set('models_quality', 3, 'triplebutton')">Vysoká</div>
        		</div>
        		<p class="menu_podnadpis1">Vykreslovací vzdálenost</p>
    			<div class="triple_button">
        			<div class="but left_arrow" onclick="settings_set('chunk_radius', ' chunks', 'decrease')"><</div>
        			<div class="but middle_display" onclick="" id="chunk_radius_display">7 chunks</div>
        			<div class="but right_arrow" onclick="settings_set('chunk_radius', ' chunks', 'increase')">></div>
        		</div>
        		<p class="menu_podnadpis1">Škálování obrazu</p>
    			<div class="triple_button">
        			<div class="but left_arrow" onclick="settings_set('display_scaling', 'x', 'decrease')"><</div>
        			<div class="but middle_display" onclick="" id="display_scaling_display">1x</div>
        			<div class="but right_arrow" onclick="settings_set('display_scaling', 'x', 'increase')">></div>
        		</div>
        		<hr>
        		<div class="triple_button">
        			<div class="but storno" onclick="window_show('settings')">Zpět</div>
        			<div class="but apply" onclick="settings_apply(game_settings);window_show('settings')">Uložit</div>
        		</div>
   		 	</div>
  		</div>

		<div id="popup">
    		<div class="popup_window">
        		<p class="popup_nadpis" id="popup_nadpis">Fuj!</p>
				<table>
					<tr>
						<td> <img id="popup_img" class="popup_img" src="/static/images/disconnected.png"> </td>
						<td> <p class="popup_text" id="popup_text">Smrdíš!</p>
							<div class="popup_button" id="popup_button" onclick="location.reload()">Vykoupat</div></td>
					</tr>
				</table>
   		 	</div>
  		</div>

<script>

function createCookie(name,value,days) {
    var expires = "";
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + value + expires + "; path=/";
}

function readCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}

if(!readCookie('chunkR'))
    createCookie('chunkR', 7, 1000);

</script>

<script>
//Výchozí nastavení, proměnné

var chunks = {};
var players = {};
var actors = {};
var position = [0,0,0];
var rotation = [0,0,0];
var scene;
var canvas = document.querySelector('canvas');
var x = canvas.clientWidth/2;
var kx = (2*Math.PI)/canvas.clientWidth;
var y = canvas.clientHeight/2;
var ky = (2*Math.PI)/canvas.clientHeight;
var sun, lightSun, shadowGenerator;
var camera;
var bFreeze = false;
var bBlockInput = false;
var rukaL, rukaR;
var traceHit;
var bInit = false;
var fps = document.getElementById("fps");
var border;
var itemL, itemR;
var holdL = 0, holdR = 0;
var bHand = false;
var mat, txt;
var shadowList = [];
</script>

<script src="/static/src/Terrain.js"></script>
<script src="/static/src/Game.js"></script>
<script src="/static/src/Loader.js"></script>
<script src="/static/src/Actors.js"></script>
<script src="/static/src/PointerLockAPI.js"></script>
<script src="/static/src/GUI.js"></script>
        
<script>

function window_show(id) {
	windows = document.getElementsByClassName('menu_window');
	for (var i in windows) {
		if (windows[i].style) {
			windows[i].style.display = 'none';
		}
	}
	document.getElementById(id+'_window').style.display = 'inline-block';
}

game_settings = {}
game_settings.models_quality = 3;
game_settings.chunk_radius = 7;
game_settings.display_scaling = 1;

borders = {}
borders.chunk_radius = [3,10];
borders.display_scaling = [1,5]

function settings_set(nam, val, typ) {
	if (typ == 'triplebutton') {
		butt = document.getElementsByClassName(nam+'_but');
		for (var i in butt) {
			if (butt[i].style) {
				butt[i].style.backgroundColor = '#0FACF3';
			}
		}
		butt[val-1].style.backgroundColor = '#3fc4ff';
		game_settings[nam] = val;
	}
	if (typ == 'increase') {
		if (game_settings[nam] < borders[nam][1]) {
			game_settings[nam] ++;
			document.getElementById(nam+'_display').innerHTML = game_settings[nam]+val;
		}
	}
	if (typ == 'decrease') {
		if (game_settings[nam] > borders[nam][0]) {
			game_settings[nam] --;
			document.getElementById(nam+'_display').innerHTML = game_settings[nam]+val;
		}
	}
}





window.onbeforeunload = function(e)
{
    socket.emit('logout');
};

index = -1;
smazat = 1;

myhash = '{{myhash}}';

window.setInterval("mazani()", 1);

function input() {
    text = document.getElementById("input").value;
    document.getElementById("input").value = "";
    
    chat = document.getElementById("chat");
    chat.scrollTop = chat.scrollHeight;
    
    smazat = 1;
                           
    socket.emit('input', text);
    
}

function mazani() {
	if(smazat){
		document.getElementById("input").value = "";
		chat.scrollTop = chat.scrollHeight;
	}
}

function klavesa() {
	smazat = 0;
	if(event.keyCode == 13){
		input();
	}
}

function popup_hide() {
	popup.style.display = "none";
	freeze(false);
}

socket.on('output', function (text)
{
    var table = document.getElementById("table");
    var row = table.insertRow(index);
    var cell = row.insertCell(index);
  
    cell.innerHTML = text +"<br>";

    chat = document.getElementById("chat");
    chat.scrollTop = chat.scrollHeight;

});

socket.on('konzole', function (text)
{
    var table = document.getElementById("table");
    var row = table.insertRow(index);
    var cell = row.insertCell(index);
  
    cell.innerHTML = text +"<br>";

    chat = document.getElementById("chat");
    chat.scrollTop = chat.scrollHeight;

});

socket.on('popup', function (data)
{
    console.log(data);
	console.log("Restart");
	popup_nadpis.innerHTML = data.header;
	popup_nadpis.style.color = data.color;
	popup_nadpis.style.borderColor = data.color;
	popup_img.setAttribute('src',data.picture);
	popup_text.innerHTML = data.text;
	popup_button.innerHTML = data.button;
	popup_button.setAttribute('onclick',data.action);
	
	popup.style.display = "block";
	freeze(true);
});

</script>
</body>
</html>
